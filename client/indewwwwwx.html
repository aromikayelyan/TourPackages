<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TravelLab ‚Äî —Ç—É—Ä—ã, –æ—Ç–∑—ã–≤—ã –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç</title>
  <meta name="description" content="–û–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞: —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤, –¥–µ—Ç–∞–ª–∏, –æ—Ç–∑—ã–≤—ã –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–æ–≤, —É–¥–∞–ª–µ–Ω–∏–µ, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Aviasales." />
  <style>
    :root{
      --bg:#0f1221;          /* —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω */
      --card:#171a2b;        /* —Ñ–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ */
      --muted:#8b90a7;       /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç */
      --text:#e8ebff;        /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --brand:#7c5cff;       /* –∞–∫—Ü–µ–Ω—Ç */
      --brand-2:#3bd9d9;     /* –≤—Ç–æ—Ä–æ–π –∞–∫—Ü–µ–Ω—Ç */
      --danger:#ff6363;
      --success:#41d689;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 1200px at 110% -10%, rgba(124,92,255,.25), transparent 45%),
                         radial-gradient(900px 900px at -10% 110%, rgba(59,217,217,.2), transparent 45%),
                         var(--bg);
         color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial}
    a{color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:24px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:20;background:rgba(15,18,33,.7);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    .topbar-inner{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:14px 24px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .logo .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
    nav a{padding:10px 14px;border-radius:10px;color:var(--muted);text-decoration:none}
    nav a.active, nav a:hover{color:var(--text);background:rgba(124,92,255,.16)}

    /* Blocks */
    .hero{display:grid;gap:12px;padding:28px 0 10px}
    .hero h1{font-size:clamp(26px,5vw,38px);margin:0}
    .hero p{margin:0;color:var(--muted)}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin:18px 0}
    .input, select{background:#12162a;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:12px;outline:none;min-width:200px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(124,92,255,.22),rgba(124,92,255,.12));color:var(--text);cursor:pointer;transition:transform .08s ease;}
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#12162a}
    .btn.danger{background:linear-gradient(180deg, rgba(255,99,99,.22), rgba(255,99,99,.12));border-color:rgba(255,99,99,.25)}
    .btn.success{background:linear-gradient(180deg, rgba(65,214,137,.22), rgba(65,214,137,.12));border-color:rgba(65,214,137,.25)}

    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .card .media{position:relative;aspect-ratio:16/10;overflow:hidden}
    .card img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .6s ease}
    .card:hover img{transform:scale(1.06)}
    .badge{position:absolute;left:12px;top:12px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;font-size:12px}
    .card .content{padding:14px 14px 16px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:700}
    .muted{color:var(--muted)}

    .section{margin:28px 0}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}

    .split{display:grid;gap:20px;grid-template-columns:1.2fr .8fr}
    @media (max-width:860px){.split{grid-template-columns:1fr}}

    .gallery{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
    .gallery img{width:100%;height:160px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.08)}

    .review{padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}

    .empty{padding:20px;text-align:center;color:var(--muted)}

    .footer{margin:40px 0 20px;color:var(--muted);text-align:center;font-size:14px}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}

    .warning{color:var(--danger)}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner container">
      <div class="logo" onclick="Router.go('/')" style="cursor:pointer">
        <span class="dot"></span>
        <span>TravelLab</span>
      </div>
      <nav>
        <a href="#/" data-link>–¢—É—Ä—ã</a>
        <a href="#/admin" data-link>–î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä</a>
        <!-- <a href="#/about" data-link>–û –ø—Ä–æ–µ–∫—Ç–µ</a> -->
      </nav>
    </div>
  </header>

  <main id="app" class="container"></main>

  <footer class="footer container">
    –°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è. –í–æ–ø—Ä–æ—Å—ã –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Äî –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ¬´–û –ø—Ä–æ–µ–∫—Ç–µ¬ª.
  </footer>

<script>
// =========================
// ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê API
// =========================
// –í–ê–ñ–ù–û: –ø–æ–¥—Å—Ç–∞–≤—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ basePath-—ã —Ç–∞–∫, –∫–∞–∫ –æ–Ω–∏ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—ç–∫–µ–Ω–¥–µ
// –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ —Ç–≤–æ–π —Ä–æ—É—Ç–µ—Ä —Å —Ç—É—Ä–∞–º–∏ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫–∞–∫ app.use('/api/tours', router)
// —Ç–æ TOURS_BASE = 'http://localhost:3000/api/tours'

const CONFIG = {
  TOURS_BASE: 'http://localhost:4400/packages', // ‚ö†Ô∏è –ü–û–î–°–¢–ê–í–¨ –°–í–û–ô –ü–£–¢–¨
  RATES_BASE: 'http://localhost:4400/rating',  // ‚ö†Ô∏è –ü–û–î–°–¢–ê–í–¨ –°–í–û–ô –ü–£–¢–¨
  CURRENCY: '‚ÇΩ',
  AFFILIATE: {
    // Placeholders –¥–ª—è Aviasales (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏ –º–µ—Ç–∫–∏)
    PARTNER_ID: 'YOUR_PARTNER_ID',
    UTM: 'utm_source=travellab&utm_medium=referral&utm_campaign=tour',
    URL: 'https://www.aviasales.ru' // –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π white-label –¥–æ–º–µ–Ω
  }
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fetch —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
async function apiFetch(url, options={}){
  try{
    const res = await fetch(url, options)
    if(!res.ok){
      const txt = await res.text().catch(()=> '')
      throw new Error(txt || `HTTP ${res.status}`)
    }
    const ct = res.headers.get('content-type')||''
    return ct.includes('application/json') ? res.json() : res.text()
  }catch(e){
    console.error('API error:', e)
    throw e
  }
}

// =========================
// üß≠ –ú–∏–Ω–∏-—Ä–æ—É—Ç–µ—Ä (hash-based)
// =========================
const Router = {
  routes: {},
  init(){
    window.addEventListener('hashchange', ()=> this.resolve())
    this.resolve()
  },
  register(path, handler){ this.routes[path] = handler },
  go(path){ location.hash = '#' + path },
  // –ø—Ä–æ—Å—Ç–µ–π—à–∏–π matcher –≤–∏–¥–∞ "/tour/:id"
  resolve(){
    const hash = location.hash.slice(1) || '/'
    const [path, ...rest] = hash.split('?')

    for(const pattern in this.routes){
      const params = {}
      const pSeg = pattern.split('/').filter(Boolean)
      const hSeg = path.split('/').filter(Boolean)
      if(pSeg.length !== hSeg.length) continue
      let ok = true
      pSeg.forEach((seg,i)=>{
        if(seg.startsWith(':')) params[seg.slice(1)] = decodeURIComponent(hSeg[i])
        else if(seg !== hSeg[i]) ok=false
      })
      if(ok){
        this.routes[pattern](params)
        this.highlightNav(path)
        return
      }
    }
    // 404
    document.getElementById('app').innerHTML = `<div class="section"><div class="panel"><h2>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2><p class="muted">–ü—Ä–æ–≤–µ—Ä—å –∞–¥—Ä–µ—Å –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.</p></div></div>`
  },
  highlightNav(path){
    document.querySelectorAll('nav a').forEach(a=>{
      const href = a.getAttribute('href')||''
      const p = href.replace('#','')
      a.classList.toggle('active', p === '#' + path || (p==='#/' && path==='/'))
    })
  }
}

// =========================
// üñºÔ∏è –†–ï–ù–î–ï–†–´ –°–¢–†–ê–ù–ò–¶
// =========================

Router.register('/', renderHome)
Router.register('/tour/:id', ({id})=> renderTour(id))
Router.register('/admin', renderAdmin)
// Router.register('/about', renderAbout)s

async function renderHome(){
  const app = document.getElementById('app')
  app.innerHTML = `
    <section class="hero">
      <h1>–ü–æ–¥–±–µ—Ä–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ç—É—Ä</h1>
      <p>–°–º–æ—Ç—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∏–∑—É—á–∞–π –¥–µ—Ç–∞–ª–∏ –∏ –æ—Å—Ç–∞–≤–ª—è–π –æ—Ç–∑—ã–≤—ã –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.</p>
      <div class="toolbar">
        <input id="q" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶" />
        <select id="sort">
          <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
          <option value="cheap">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à—ë–≤—ã–µ</option>
          <option value="expensive">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
          <option value="recent">–ü–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞</option>
        </select>
        <button class="btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn secondary" onclick="Router.go('/admin')">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä</button>
      </div>
    </section>
    <section class="section">
      <div id="cards" class="grid"></div>
    </section>
  `

  const q = document.getElementById('q')
  const sortSel = document.getElementById('sort')
  const cards = document.getElementById('cards')
  const refreshBtn = document.getElementById('refreshBtn')

  async function load(){
    cards.innerHTML = `<div class="panel">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`
    try{
      const data = await apiFetch(`${CONFIG.TOURS_BASE}/`)
      let list = Array.isArray(data) ? data : []
      // –ø–æ–∏—Å–∫
      const query = (q.value||'').trim().toLowerCase()
      if(query) list = list.filter(t => (t.name||'').toLowerCase().includes(query))
      // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      const sort = sortSel.value
      list.sort((a,b)=>{
        if(sort==='cheap') return (a.price||0)-(b.price||0)
        if(sort==='expensive') return (b.price||0)-(a.price||0)
        if(sort==='recent') return new Date(a.startDate||0) - new Date(b.startDate||0)
        return (b.forSlide?1:0)-(a.forSlide?1:0) // popular proxy
      })

      if(!list.length){
        cards.innerHTML = `<div class='empty panel'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.</div>`
        return
      }

      cards.innerHTML = list.map(item=> TourCard(item)).join('')
      // attach listeners to cards
      cards.querySelectorAll('[data-open]').forEach(btn=>{
        btn.addEventListener('click', ()=> Router.go(`/tour/${btn.getAttribute('data-open')}`))
      })
    }catch(e){
      cards.innerHTML = `<div class='panel warning'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–æ–≤: ${e.message}</div>`
    }
  }

  q.addEventListener('input', debounce(load, 250))
  sortSel.addEventListener('change', load)
  refreshBtn.addEventListener('click', load)
  load()
}

function TourCard(t){
  const cover = (t.images && t.images[0]) || placeholder()
  const price = t.price ? `${t.price.toLocaleString()} ${CONFIG.CURRENCY}` : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É'
  const seats = t.availableSeats ?? '‚Äî'
  const dur = t.duration || '‚Äî'
  const badge = t.forSlide ? '–•–∏—Ç' : '–¢—É—Ä'
  return `
    <article class="card">
      <div class="media">
        <img src="${cover}" alt="${escapeHtml(t.name||'–¢—É—Ä')}" />
        <span class="badge">${badge}</span>
      </div>
      <div class="content">
        <div class="title">${escapeHtml(t.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
        <div class="muted">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${escapeHtml(dur)} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç: ${escapeHtml(String(seats))}</div>
        <div class="chips">
          ${t.startDate ? `<span class='chip'>–°—Ç–∞—Ä—Ç: ${fmtDate(t.startDate)}</span>`:''}
          ${t.endDate ? `<span class='chip'>–§–∏–Ω–∏—à: ${fmtDate(t.endDate)}</span>`:''}
          <span class="chip">${price}</span>
        </div>
        <div style="margin-top:8px;display:flex;gap:10px">
          <button class="btn" data-open="${t.uid}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          <button class="btn danger" onclick="handleDelete('${t.uid}')">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </article>
  `
}

async function handleDelete(uid){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä?')) return
  try{
    await apiFetch(`${CONFIG.TOURS_BASE}/${encodeURIComponent(uid)}`, { method:'DELETE' })
    alert('–£–¥–∞–ª–µ–Ω–æ')
    Router.go('/')
    // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –ª–∏—Å—Ç–∏–Ω–≥
    renderHome()
  }catch(e){
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message)
  }
}

async function renderTour(uid){
  const app = document.getElementById('app')
  app.innerHTML = `<div class='section'><div class='panel'>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>`
  try{
    const payload = await apiFetch(`${CONFIG.TOURS_BASE}/${encodeURIComponent(uid)}`)
    const [t, comments] = payload || []
    if(!t) throw new Error('–¢—É—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω')

    const gallery = (t.images||[]).map(src=> `<img src="${src}" alt="img"/>`).join('') || `<div class='empty'>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>`
    const avg = (comments||[]).length ? (comments.reduce((s,c)=> s + (c.rate||0),0) / comments.length).toFixed(1) : '‚Äî'

    app.innerHTML = `
      <section class="section">
        <div class="split">
          <div class="panel">
            <div class="gallery">${gallery}</div>
            <h2 style="margin:12px 4px 8px">${escapeHtml(t.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h2>
            <p class="muted" style="white-space:pre-wrap">${escapeHtml(t.description||'–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç')}</p>
            <div class="chips" style="margin-top:10px">
              <span class="chip">–¶–µ–Ω–∞: ${t.price ? `${Number(t.price).toLocaleString()} ${CONFIG.CURRENCY}` : '‚Äî'}</span>
              ${t.duration ? `<span class='chip'>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${escapeHtml(t.duration)}</span>`:''}
              ${t.availableSeats!=null ? `<span class='chip'>–î–æ—Å—Ç—É–ø–Ω–æ –º–µ—Å—Ç: ${escapeHtml(String(t.availableSeats))}</span>`:''}
              ${t.startDate ? `<span class='chip'>–°—Ç–∞—Ä—Ç: ${fmtDate(t.startDate)}</span>`:''}
              ${t.endDate ? `<span class='chip'>–§–∏–Ω–∏—à: ${fmtDate(t.endDate)}</span>`:''}
              <span class="chip">‚≠ê ${avg}</span>
            </div>

            <div class="section">
              <h3 style="margin:0 0 8px">–î–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –º–µ—Å—Ç–∞ (Aviasales)</h3>
              <div class="panel" style="background:rgba(124,92,255,.06)">
                <p class="muted" style="margin-top:0">–î–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π —Å—Å—ã–ª–∫–∏ –ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π ID –Ω–∏–∂–µ. –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω—É—é Aviasales.</p>
                <div class="toolbar">
                  <input id="fromCity" class="input" placeholder="–û—Ç–∫—É–¥–∞ (–≥–æ—Ä–æ–¥)" />
                  <input id="toCity" class="input" placeholder="–ö—É–¥–∞ (–≥–æ—Ä–æ–¥/—Å—Ç—Ä–∞–Ω–∞)" />
                  <input id="dateFly" class="input" type="date" />
                  <button class="btn" id="flyBtn">–ù–∞–π—Ç–∏ –±–∏–ª–µ—Ç—ã</button>
                </div>
                <div class="hint">–ü–∞—Ä—Ç–Ω—ë—Ä: <b>${CONFIG.AFFILIATE.PARTNER_ID}</b> ‚Ä¢ UTM: <code>${CONFIG.AFFILIATE.UTM}</code></div>
              </div>
            </div>
          </div>

          <aside class="panel">
            <h3 style="margin-top:0">–û—Ç–∑—ã–≤—ã</h3>
            <div id="reviewsWrap">
              ${(comments||[]).length ? comments.map(c=> ReviewItem(c)).join('') : `<div class='empty'>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ ‚Äî —Å—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>`}
            </div>
            <hr style="border-color:rgba(255,255,255,.08);margin:16px 0" />
            <h3 style="margin:0 0 8px">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
            <form id="reviewForm" class="section" onsubmit="return false">
              <input required name="userName" class="input" placeholder="–í–∞—à–µ –∏–º—è" />
              <textarea required name="comment" class="input" style="min-height:90px" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
              <label class="hint">–û—Ü–µ–Ω–∫–∞ (1‚Äì5)</label>
              <input required name="rate" class="input" type="number" min="1" max="5" value="5" />
              <div style="display:flex;gap:10px;margin-top:10px">
                <button class="btn success" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn secondary" type="reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
              <div id="reviewMsg" class="hint" style="margin-top:8px"></div>
            </form>
          </aside>
        </div>
      </section>
    `

    // Aviasales link opener
    document.getElementById('flyBtn').addEventListener('click', ()=>{
      const from = encodeURIComponent(document.getElementById('fromCity').value.trim())
      const to = encodeURIComponent(document.getElementById('toCity').value.trim())
      const date = document.getElementById('dateFly').value // YYYY-MM-DD
      const dateStr = date ? `&date=${encodeURIComponent(date)}` : ''
      const base = CONFIG.AFFILIATE.URL
      const utm = CONFIG.AFFILIATE.UTM ? (base.includes('?')? '&':'?') + CONFIG.AFFILIATE.UTM : ''
      // –û—Ç–∫—Ä–æ–µ–º –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫—É—é –≥–ª–∞–≤–Ω—É—é, –∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–æ—Ä–æ–¥–æ–≤ –¥–æ–±–∞–≤–∏–º –∫–∞–∫ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞)
      const url = `${base}${utm}`
      window.open(url, '_blank')
    })

    // review form
    const form = document.getElementById('reviewForm')
    const msg = document.getElementById('reviewMsg')
    form.addEventListener('submit', async ()=>{
      msg.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶'
      const payload = Object.fromEntries(new FormData(form).entries())
      payload.rate = Number(payload.rate)
      try{
        await apiFetch(`${CONFIG.RATES_BASE}/${encodeURIComponent(uid)}`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        })
        msg.textContent = '–°–ø–∞—Å–∏–±–æ! –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.'
        form.reset()
        // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –±–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤
        renderTour(uid)
      }catch(e){
        msg.textContent = '–û—à–∏–±–∫–∞: ' + e.message
      }
    })

  }catch(e){
    app.innerHTML = `<div class='section'><div class='panel warning'>${escapeHtml(e.message)}</div></div>`
  }
}

function ReviewItem(c){
  const stars = '‚òÖ'.repeat(Math.max(1, Math.min(5, Number(c.rate)||0)))
  return `<div class='review'><div><b>${escapeHtml(c.userName||'–ê–Ω–æ–Ω–∏–º')}</b> <span class='muted'>${stars}</span></div><div>${escapeHtml(c.comment||'')}</div></div>`
}

function renderAdmin(){
  const app = document.getElementById('app')
  app.innerHTML = `
    <section class="section">
      <div class="panel">
        <h2 style="margin-top:0">–î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä</h2>
        <form id="addForm" onsubmit="return false" enctype="multipart/form-data">
          <div class="split">
            <div>
              <label class="hint">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–∞</label>
              <input name="name" class="input" required placeholder="–ù–∞–ø—Ä.: –ö–∞–∑–±–µ–∫ ‚Äî –≤–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ" />

              <label class="hint">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description" class="input" style="min-height:120px" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ"></textarea>

              <div class="toolbar">
                <div style="flex:1">
                  <label class="hint">–¶–µ–Ω–∞</label>
                  <input name="price" class="input" type="number" min="0" placeholder="50000" />
                </div>
                <div style="flex:1">
                  <label class="hint">–î–æ—Å—Ç—É–ø–Ω–æ –º–µ—Å—Ç</label>
                  <input name="availableSeats" class="input" type="number" min="0" placeholder="12" />
                </div>
              </div>

              <div class="toolbar">
                <div style="flex:1">
                  <label class="hint">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                  <input name="duration" class="input" placeholder="7 –¥–Ω–µ–π / 6 –Ω–æ—á–µ–π" />
                </div>
                <div style="flex:1">
                  <label class="hint">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∫–∞–∫ —Ö–∏—Ç (forSlide)</label>
                  <select name="forSlide" class="input">
                    <option value="false">–ù–µ—Ç</option>
                    <option value="true">–î–∞</option>
                  </select>
                </div>
              </div>

              <div class="toolbar">
                <div style="flex:1">
                  <label class="hint">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                  <input name="startDate" class="input" type="date" />
                </div>
                <div style="flex:1">
                  <label class="hint">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                  <input name="endDate" class="input" type="date" />
                </div>
              </div>
            </div>

            <div>
              <label class="hint">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 3 —à—Ç.)</label>
              <input name="images" class="input" type="file" accept="image/*" multiple />
              <div id="preview" class="gallery" style="margin-top:10px"></div>
            </div>
          </div>
          <div style="display:flex;gap:10px;margin-top:16px">
            <button class="btn success" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn secondary" type="button" onclick="Router.go('/')">–û—Ç–º–µ–Ω–∞</button>
          </div>
          <div id="addMsg" class="hint" style="margin-top:8px"></div>
        </form>
      </div>
    </section>
  `

  // –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  const fileInput = document.querySelector('input[name="images"]')
  const preview = document.getElementById('preview')
  fileInput.addEventListener('change', ()=>{
    preview.innerHTML = ''
    const files = Array.from(fileInput.files||[]).slice(0,3)
    files.forEach(f=>{
      const url = URL.createObjectURL(f)
      const img = document.createElement('img')
      img.src = url
      preview.appendChild(img)
    })
  })

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
  const form = document.getElementById('addForm')
  const msg = document.getElementById('addMsg')
  form.addEventListener('submit', async ()=>{
    msg.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶'
    try{
      const fd = new FormData(form)
      // –æ–≥—Ä–∞–Ω–∏—á–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—Ä–µ–º—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–æ–ª—è (multer –∂–¥—ë—Ç fieldname "images")
      const imgs = Array.from(fileInput.files||[]).slice(0,3)
      fd.delete('images')
      imgs.forEach(f=> fd.append('images', f))

      // –±—É–ª–µ–≤–æ –∑–Ω–∞—á–µ–Ω–∏–µ forSlide –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å—Ç—Ä–æ–∫–µ 'true'/'false' ‚Äî –±—ç–∫–µ–Ω–¥ –ø—Ä–∏–º–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç
      // (sequelize boolean –ø—Ä–∏–≤–µ–¥—ë—Ç —Å–∞–º)

      const res = await fetch(`${CONFIG.TOURS_BASE}/`, { method:'POST', body: fd })
      if(!res.ok){ throw new Error(await res.text()) }
      msg.textContent = '–¢—É—Ä –¥–æ–±–∞–≤–ª–µ–Ω!'
      setTimeout(()=> Router.go('/'), 600)
    }catch(e){
      msg.textContent = '–û—à–∏–±–∫–∞: ' + (e.message||'')
    }
  })
}

function renderAbout(){
  const app = document.getElementById('app')
  app.innerHTML = `
    <section class="section">
      <div class="panel">
        <h2 style="margin-top:0">–û –ø—Ä–æ–µ–∫—Ç–µ</h2>
        <p>–≠—Ç–æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Äî –ª—ë–≥–∫–æ–µ SPA –Ω–∞ —á–∏—Å—Ç—ã—Ö HTML/CSS/JS –¥–ª—è –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ Express + Sequelize.</p>
        <ul>
          <li>–°–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤ ‚Üí <code>GET {TOURS_BASE}/</code></li>
          <li>–î–µ—Ç–∞–ª–∏ —Ç—É—Ä–∞ + –æ—Ç–∑—ã–≤—ã ‚Üí <code>GET {TOURS_BASE}/:uid</code> (–æ—Ç–≤–µ—Ç: <code>[tour, comments]</code>)</li>
          <li>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–∞ ‚Üí <code>POST {TOURS_BASE}/</code> (multipart: <code>images[]</code> + –ø–æ–ª—è —Ñ–æ—Ä–º—ã)</li>
          <li>–£–¥–∞–ª–µ–Ω–∏–µ —Ç—É—Ä–∞ ‚Üí <code>DELETE {TOURS_BASE}/:uid</code></li>
          <li>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ ‚Üí <code>POST {RATES_BASE}/:uid</code> (JSON: <code>{ userName, comment, rate }</code>)</li>
        </ul>
        <p class="hint">–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏ CORS ‚Äî –≤–∫–ª—é—á–∏—Ç–µ <code>cors()</code> –≤ Express: <code>import cors from 'cors'; app.use(cors())</code>.</p>
        <h3>Aviasales (—Ä–µ–∫–ª–∞–º–∞/–ø–∞—Ä—Ç–Ω—ë—Ä–∫–∞)</h3>
        <p>–í —ç—Ç–æ–º —à–∞–±–ª–æ–Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–π—Ç–∏ –±–∏–ª–µ—Ç—ã¬ª. –ó–∞–º–µ–Ω–∏—Ç–µ <code>CONFIG.AFFILIATE.PARTNER_ID</code> –∏ <code>CONFIG.AFFILIATE.URL</code> –Ω–∞ –≤–∞—à white‚Äëlabel/–ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –¥–æ–º–µ–Ω.</p>
        <p class="muted">–ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å –≤–∏–¥–∂–µ—Ç —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞ Aviasales, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç –∏ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–ª—é—á ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ —Å—é–¥–∞, –≤ —Ä–∞–∑–¥–µ–ª ¬´–î–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –º–µ—Å—Ç–∞¬ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç—É—Ä–∞.</p>
        <h3>–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å</h3>
        <ol>
          <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ <code>index.html</code>.</li>
          <li>–û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏–ª–∏ —Å–µ—Ä–≤–∏—Ç–µ —Å—Ç–∞—Ç–∏–∫–æ–π —á–µ—Ä–µ–∑ <code>serve</code> / <code>nginx</code>.</li>
          <li>–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ <code>CONFIG.TOURS_BASE</code> –∏ <code>CONFIG.RATES_BASE</code> –ø–æ–¥ –≤–∞—à–∏ mount-–ø—É—Ç–∏.</li>
        </ol>
      </div>
    </section>
  `.replace('{TOURS_BASE}', CONFIG.TOURS_BASE)
   .replace('{RATES_BASE}', CONFIG.RATES_BASE)
}

// =========================
// üîß –£—Ç–∏–ª–∏—Ç—ã
// =========================
function fmtDate(d){
  try{ return new Date(d).toLocaleDateString('ru-RU') }catch{ return d }
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]))
}
function debounce(fn, ms){
  let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms) }
}
function placeholder(){
  // –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞-–≥—Ä–∞–¥–∏–µ–Ω—Ç
  const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%237c5cff' offset='0'/><stop stop-color='%233bd9d9' offset='1'/></linearGradient></defs><rect width='100%' height='100%' fill='url(%23g)'/><text x='50%' y='52%' font-family='Verdana' font-size='36' fill='white' text-anchor='middle'>TravelLab</text></svg>`)
  return `data:image/svg+xml;utf8,${svg}`
}

// –ó–∞–ø—É—Å–∫
Router.init()
</script>
</body>
</html>
